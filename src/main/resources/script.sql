SET DB_CLOSE_DELAY -1;        
;             
CREATE USER IF NOT EXISTS "" SALT '' HASH '' ADMIN;
DROP VIEW IF EXISTS PUBLIC.ACTVITY_VIEW;
DROP TABLE IF EXISTS PUBLIC.SCOBJ2MSG CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCOBJ2USR CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCOBJ CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCOBJTYPE CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCACTVTY CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCVERB CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCMSG CASCADE;
DROP TABLE IF EXISTS PUBLIC.SCUSER CASCADE;          
CREATE MEMORY TABLE PUBLIC.SCUSER(
    ID INT NOT NULL,
    NAME VARCHAR(255)
);           
ALTER TABLE PUBLIC.SCUSER ADD CONSTRAINT PUBLIC.CONSTRAINT_9 PRIMARY KEY(ID); 
-- 4 +/- SELECT COUNT(*) FROM PUBLIC.SCUSER;  
INSERT INTO PUBLIC.SCUSER(ID, NAME) VALUES
(1, 'ADMIN'),
(2, 'DEVELOPER'),
(3, 'TESTER'),
(4, 'QMANAGER');
CREATE MEMORY TABLE PUBLIC.SCMSG(
    ID INT NOT NULL,
    USER_ID INT,
    CNTNT VARCHAR(255)
);         
ALTER TABLE PUBLIC.SCMSG ADD CONSTRAINT PUBLIC.CONSTRAINT_4 PRIMARY KEY(ID);  
-- 4 +/- SELECT COUNT(*) FROM PUBLIC.SCMSG;   
INSERT INTO PUBLIC.SCMSG(ID, USER_ID, CNTNT) VALUES
(1, 1, 'LET''S BEGIN'),
(2, 4, 'TNX DUDES FOR ALL'),
(3, 2, 'What are you waiting for, Christmas?'),
(4, 3, 'Tnx a lot');             
CREATE MEMORY TABLE PUBLIC.SCVERB(
    ID INT NOT NULL,
    VERB VARCHAR(255),
    SHOWVERB VARCHAR(255)
);               
ALTER TABLE PUBLIC.SCVERB ADD CONSTRAINT PUBLIC.CONSTRAINT_91 PRIMARY KEY(ID);
-- 3 +/- SELECT COUNT(*) FROM PUBLIC.SCVERB;  
INSERT INTO PUBLIC.SCVERB(ID, VERB, SHOWVERB) VALUES
(1, 'USR_CREATED', 'CREATED NEW USER'),
(2, 'ADM_BANNED', 'BANNED'),
(3, 'USR_POST_MSG', 'ADDED MESSAGE');            
CREATE MEMORY TABLE PUBLIC.SCACTVTY(
    ID INT NOT NULL,
    DT TIMESTAMP,
    USER_ID INT,
    VERB_ID INT
);          
ALTER TABLE PUBLIC.SCACTVTY ADD CONSTRAINT PUBLIC.CONSTRAINT_F PRIMARY KEY(ID);               
-- 8 +/- SELECT COUNT(*) FROM PUBLIC.SCACTVTY;
INSERT INTO PUBLIC.SCACTVTY(ID, DT, USER_ID, VERB_ID) VALUES
(1, TIMESTAMP '2015-08-27 09:00:00.0', 1, 3),
(2, TIMESTAMP '2015-08-27 09:01:00.0', 1, 1),
(3, TIMESTAMP '2015-08-27 09:02:00.0', 1, 1),
(4, TIMESTAMP '2015-08-27 09:03:00.0', 1, 1),
(5, TIMESTAMP '2015-08-27 09:04:00.0', 4, 3),
(6, TIMESTAMP '2015-08-27 09:05:00.0', 2, 3),
(7, TIMESTAMP '2015-08-27 09:06:00.0', 3, 3),
(8, TIMESTAMP '2015-08-27 09:07:00.0', 1, 2);          
CREATE MEMORY TABLE PUBLIC.SCOBJTYPE(
    ID INT NOT NULL,
    OBJNAME VARCHAR(255)
);     
ALTER TABLE PUBLIC.SCOBJTYPE ADD CONSTRAINT PUBLIC.CONSTRAINT_A PRIMARY KEY(ID);              
-- 2 +/- SELECT COUNT(*) FROM PUBLIC.SCOBJTYPE;               
INSERT INTO PUBLIC.SCOBJTYPE(ID, OBJNAME) VALUES
(1, 'SCUSER'),
(2, 'SCMESSAGE');           
CREATE MEMORY TABLE PUBLIC.SCOBJ(
    ID INT NOT NULL,
    ACTVTY_ID INT,
    OBJTYPE_ID INT
);           
ALTER TABLE PUBLIC.SCOBJ ADD CONSTRAINT PUBLIC.CONSTRAINT_4B PRIMARY KEY(ID); 
-- 8 +/- SELECT COUNT(*) FROM PUBLIC.SCOBJ;   
INSERT INTO PUBLIC.SCOBJ(ID, ACTVTY_ID, OBJTYPE_ID) VALUES
(1, 1, 2),
(2, 2, 1),
(3, 3, 1),
(4, 4, 1),
(5, 5, 2),
(6, 6, 2),
(7, 7, 2),
(8, 8, 1);    
CREATE MEMORY TABLE PUBLIC.SCOBJ2USR(
    ID INT NOT NULL,
    USER_ID INT
);              
ALTER TABLE PUBLIC.SCOBJ2USR ADD CONSTRAINT PUBLIC.CONSTRAINT_9F PRIMARY KEY(ID);             
-- 4 +/- SELECT COUNT(*) FROM PUBLIC.SCOBJ2USR;               
INSERT INTO PUBLIC.SCOBJ2USR(ID, USER_ID) VALUES
(2, 2),
(3, 3),
(4, 4),
(8, 4);          
CREATE MEMORY TABLE PUBLIC.SCOBJ2MSG(
    ID INT NOT NULL,
    MSG_ID INT
);               
ALTER TABLE PUBLIC.SCOBJ2MSG ADD CONSTRAINT PUBLIC.CONSTRAINT_9F5 PRIMARY KEY(ID);            
-- 4 +/- SELECT COUNT(*) FROM PUBLIC.SCOBJ2MSG;               
INSERT INTO PUBLIC.SCOBJ2MSG(ID, MSG_ID) VALUES
(1, 1),
(5, 2),
(6, 3),
(7, 4);           
CREATE FORCE VIEW PUBLIC.ACTVITY_VIEW(ID, DT, DT_CHR, SUBJ_NAME, VERB_SYSNAME, VERB_SHOWNAME, OBJECT_ID, OBJTYPE, OBJECT_VALUE) AS
SELECT
    A.ID,
    A.DT,
    TO_CHAR(A.DT, 'yyyy.MM.dd HH:mi:ss') AS DT_CHR,
    SBJ.NAME AS SUBJ_NAME,
    V.VERB AS VERB_SYSNAME,
    V.SHOWVERB AS VERB_SHOWNAME,
    VO.ID AS OBJECT_ID,
    VOT.OBJNAME AS OBJTYPE,
    CASE VOT.OBJNAME WHEN 'SCUSER' THEN OUSR.NAME ELSE OMSG.CNTNT END AS OBJECT_VALUE
FROM PUBLIC.SCACTVTY A
    /* PUBLIC.SCACTVTY.tableScan */
LEFT OUTER JOIN PUBLIC.SCUSER SBJ
    /* PUBLIC.PRIMARY_KEY_9: ID = A.USER_ID */
    ON A.USER_ID = SBJ.ID
LEFT OUTER JOIN PUBLIC.SCVERB V
    /* PUBLIC.PRIMARY_KEY_91: ID = A.VERB_ID */
    ON A.VERB_ID = V.ID
LEFT OUTER JOIN PUBLIC.SCOBJ VO
    /* PUBLIC.SCOBJ_ACTVTY_FK_INDEX_4: ACTVTY_ID = A.ID */
    ON A.ID = VO.ACTVTY_ID
LEFT OUTER JOIN PUBLIC.SCOBJTYPE VOT
    /* PUBLIC.PRIMARY_KEY_A: ID = VO.OBJTYPE_ID */
    ON VO.OBJTYPE_ID = VOT.ID
LEFT OUTER JOIN PUBLIC.SCOBJ2USR OUSRPARAM
    /* PUBLIC.PRIMARY_KEY_9F: ID = VO.ID */
    ON (VOT.OBJNAME = 'SCUSER')
    AND (VO.ID = OUSRPARAM.ID)
LEFT OUTER JOIN PUBLIC.SCUSER OUSR
    /* PUBLIC.PRIMARY_KEY_9: ID = OUSRPARAM.USER_ID */
    ON OUSRPARAM.USER_ID = OUSR.ID
LEFT OUTER JOIN PUBLIC.SCOBJ2MSG OMSGPARAM
    /* PUBLIC.PRIMARY_KEY_9F5: ID = VO.ID */
    ON (VOT.OBJNAME = 'SCMESSAGE')
    AND (VO.ID = OMSGPARAM.ID)
LEFT OUTER JOIN PUBLIC.SCMSG OMSG
    /* PUBLIC.PRIMARY_KEY_4: ID = OMSGPARAM.MSG_ID */
    ON OMSGPARAM.MSG_ID = OMSG.ID
ORDER BY 2;       
ALTER TABLE PUBLIC.SCACTVTY ADD CONSTRAINT PUBLIC.SCACTVTY_VERB_FK FOREIGN KEY(VERB_ID) REFERENCES PUBLIC.SCVERB(ID) NOCHECK; 
ALTER TABLE PUBLIC.SCOBJ2MSG ADD CONSTRAINT PUBLIC.SCOBJ2MSG_FK FOREIGN KEY(ID) REFERENCES PUBLIC.SCOBJ(ID) ON DELETE CASCADE NOCHECK;        
ALTER TABLE PUBLIC.SCMSG ADD CONSTRAINT PUBLIC.SCMSG_FK FOREIGN KEY(USER_ID) REFERENCES PUBLIC.SCUSER(ID) NOCHECK;            
ALTER TABLE PUBLIC.SCOBJ ADD CONSTRAINT PUBLIC.SCOBJ_OBJTYPE_FK FOREIGN KEY(OBJTYPE_ID) REFERENCES PUBLIC.SCOBJTYPE(ID) NOCHECK;              
ALTER TABLE PUBLIC.SCOBJ ADD CONSTRAINT PUBLIC.SCOBJ_ACTVTY_FK FOREIGN KEY(ACTVTY_ID) REFERENCES PUBLIC.SCACTVTY(ID) NOCHECK; 
ALTER TABLE PUBLIC.SCOBJ2USR ADD CONSTRAINT PUBLIC.SCOBJ2USR_FK FOREIGN KEY(ID) REFERENCES PUBLIC.SCOBJ(ID) ON DELETE CASCADE NOCHECK;        
ALTER TABLE PUBLIC.SCOBJ2USR ADD CONSTRAINT PUBLIC.SCOBJ2USR_USER_FK FOREIGN KEY(USER_ID) REFERENCES PUBLIC.SCUSER(ID) NOCHECK;               
ALTER TABLE PUBLIC.SCOBJ2MSG ADD CONSTRAINT PUBLIC.SCOBJ2MSG_MSG_FK FOREIGN KEY(MSG_ID) REFERENCES PUBLIC.SCMSG(ID) NOCHECK;  
ALTER TABLE PUBLIC.SCACTVTY ADD CONSTRAINT PUBLIC.SCACTVTY_USER_FK FOREIGN KEY(USER_ID) REFERENCES PUBLIC.SCUSER(ID) NOCHECK; 
